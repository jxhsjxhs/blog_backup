---
title: MTU是什么
date: 2020-05-23 15:57:01
tags:
---

### 什么是MTU
Maximum Transmission Unit，缩写MTU，中文名是：最大传输单元。

### 这是哪一层网络的概念？
从下面这个表格中可以看到，在7层网络协议中，MTU是数据链路层的概念。MTU限制的是数据链路层的payload，也就是上层协议的大小，例如IP，ICMP等。

### MTU有什么用？
举一个最简单的场景，你在家用自己的笔记本上网，用的是路由器，路由器连接电信网络，然后访问了www.baidu.com，从你的笔记本出发的一个以太网数据帧总共经过了以下路径：
```
笔记本 -> 路由器 -> 电信机房 -> 服务器
```
其中，每个节点都有一个MTU值，如下：
```
1500     1500                 1500
笔记本 -> 路由器 -> 电信机房  -> 服务器
```
假设现在我把笔记本的MTU最大值设置成了1700，然后发送了一个超大的ip数据包（2000），这时候在以外网传输的时候会被拆成2个包，一个1700，一个300，然后加上头信息进行传输。
```
1700     1500                1500
笔记本 -> 路由器 -> 电信机房 -> 服务器
```
路由器接收到了一个1700的帧，发现大于自己设置的最大值：1500，如果IP包DF标志位为1，也就是不允许分包，那么路由器直接就把这个包丢弃了，根本就不会到达电信机房，也就到不了服务器了，所以，到这里我们就会发现，MTU其实就是在每一个节点的管控值，只要是大于这个值的数据帧，要么选择分片，要么直接丢弃。



### MTU遇到calico
这里分享一个前不久的k8s集群排障过程。
一天新搭建的集群各个节点看起来都是ok的但是只有同主机的pod才能访问的通,跨主机的通讯都有问题。当时的calico用的ipip模式，也就是每一台机器相当于一个路由器。互相通讯的时候通过主机的路由去寻路。
![DeepinScreenshot_select-area_20200524123309.png](https://i.loli.net/2020/05/24/PMKpLNv7Q6C1y9Z.png)

`IPIP` 是linux内核的驱动程序，可以对数据包进行隧道，上图可以看到两个不同的网络 vlan1 和 vlan2。基于现有的以太网将原始包中的原始IP进行一次封装，通过tunl0解包，这个tunl0类似于ipip模块，和Flannel vxlan的veth很类似。


Pod1 访问 Pod2 流程如下：
1、数据包从 Pod1 出到达Veth Pair另一端（宿主机上，以cali前缀开头）。

2、进入IP隧道设备（tunl0），由Linux内核IPIP驱动封装，把源容器ip换成源宿主机ip，目的容器ip换成目的主机ip，这样就封装成 Node1 到 Node2 的数据包。
```
此时包的类型：
  原始IP包：
  源IP：10.244.1.10
  目的IP：10.244.2.10

   TCP：
   源IP: 192.168.31.62
   目的iP：192.168.32.63
```
3、数据包经过路由器三层转发到 Node2。

4、Node2 收到数据包后，网络协议栈会使用IPIP驱动进行解包，从中拿到原始IP包。

5、然后根据路由规则，将数据包转发给cali设备，从而到达 Pod2。

经过排障发现,当时主机的MTU为1454,而docker的MTU为1500.
![DeepinScreenshot_select-area_20200524123542.png](https://i.loli.net/2020/05/24/PIbBLknaqUKYrJM.png)

找到问题以后处理就很简单了。要么改主机的MTU要么改calico的。由于这里是云主机 改主机MTU可能会引发其他问题。所以我改了calico的MTU。问题修复